name: do-release
description: 'Delete existing OW release on GitHub'
inputs:
  tag:
    description: 'tag used for release'
    required: false
    default: ''
    type: string
  owdebug:
    description: 'verbosed/debug output for GH Actions scripts development'
    required: false
    default: ''
    type: string
runs:
  using: composite
  steps:
  - id: curlcmd
    run: >
      if( "${{ inputs.owdebug }}" -eq '1' ) {
        'opts=-sv' | Out-File -FilePath ${{ github.output }} -Encoding utf8 -Append
      } else {
        'opts=-s' | Out-File -FilePath ${{ github.output }} -Encoding utf8 -Append
      }
    shell: pwsh      
  - id: ghrel
    run: |
      $response = curl ${{ steps.curlcmd.outputs.opts }} -L `
      "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ inputs.tag }}" `
      -H "Accept: application/vnd.github+json" `
      -H "Authorization: Bearer ${{ github.token }}" `
      -H "X-GitHub-Api-Version: 2022-11-28"
      if( "${{ inputs.owdebug }}" -eq '1' ) { $response }
      $id = $response | jq -r .id
      if( "$id" -eq 'null' ) { $id = '' }
      $id | Join-String -OutputPrefix 'id=' | Out-File -FilePath ${{ github.output }} -Encoding utf8 -Append
    shell: pwsh
  - if: steps.ghrel.outputs.id != ''
    name: "Remove Release Assets"
    run: |
      echo "${{ steps.ghrel.outputs.id }}"
      $response = curl ${{ steps.curlcmd.outputs.opts }} -L `
      "https://api.github.com/repos/${{ github.repository }}/releases/${{ steps.ghrel.outputs.id }}/assets" `
      -H "Accept: application/vnd.github+json" `
      -H "Authorization: Bearer ${{ github.token }}" `
      -H "X-GitHub-Api-Version: 2022-11-28"
      if( "${{ inputs.owdebug }}" -eq '1' ) { $response }
      $id = $response | jq -r .[].id
      if( "$id" -eq 'null' ) { $id = '' }
      $id | Foreach-Object {
        $response = curl ${{ steps.curlcmd.outputs.opts }} -L -X DELETE `
        "https://api.github.com/repos/${{ github.repository }}/releases/assets/$_" `
        -H "Accept: application/vnd.github+json" `
        -H "Authorization: Bearer ${{ github.token }}" `
        -H "X-GitHub-Api-Version: 2022-11-28"
        if( "${{ inputs.owdebug }}" -eq '1' ) { $response }
      }
    shell: pwsh
  - if: steps.ghrel.outputs.id != ''
    name: "Remove Release"
    run: |
      $response = curl ${{ steps.curlcmd.outputs.opts }} -L -X DELETE `
      "https://api.github.com/repos/${{ github.repository }}/releases/${{ steps.ghrel.outputs.id }}" `
      -H "Accept: application/vnd.github+json" `
      -H "Authorization: Bearer ${{ github.token }}" `
      -H "X-GitHub-Api-Version: 2022-11-28"
      if( "${{ inputs.owdebug }}" -eq '1' ) { $response }
    shell: pwsh
  - name: "Remove Release Tag"
    run: |
      $response = curl ${{ steps.curlcmd.outputs.opts }} -L -X DELETE `
      "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/${{ inputs.tag }}" `
      -H "Accept: application/vnd.github+json" `
      -H "Authorization: Bearer ${{ github.token }}" `
      -H "X-GitHub-Api-Version: 2022-11-28"
      if( "${{ inputs.owdebug }}" -eq '1' ) { $response }
    shell: pwsh

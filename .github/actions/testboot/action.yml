name: test-boot
description: 'Process test bootstrap build by OW (for test compatibility)'
inputs:
  suffix:
    description: 'artifact name suffix'
    required: true
    type: string
  ow_version:
    description: 'OW version'
    required: false
    default: ''
    type: string
  ow_tag:
    description: 'OW version tag'
    required: false
    default: ''
    type: string
runs:
  using: composite
  steps:
  - if: inputs.ow_version != ''
    name: Open Watcom setup
    uses: open-watcom/setup-watcom@v0
    with:
      version: ${{ inputs.ow_version }}
      tag:     ${{ inputs.ow_tag }}
  - if: inputs.ow_version == ''
    name: Load Artifact
    uses: ./.github/actions/artfload
    with:
      gitpath:    'rel'
      artifact:   rel ${{ inputs.suffix }}
  - if: inputs.ow_version == '' && runner.os == 'Linux' && runner.arch == 'X64'
    name: Setup new OW
    run: |
      echo "${{github.workspace}}/rel/binl" >> "$GITHUB_PATH"
      echo "WATCOM=${{github.workspace}}/rel" >> "$GITHUB_ENV"
      echo "INCLUDE=${{github.workspace}}/rel/lh" >> "$GITHUB_ENV"
    shell: bash
  - if: inputs.ow_version == '' && runner.os == 'Linux' && runner.arch == 'ARM64'
    name: Setup new OW
    run: |
      echo "${{github.workspace}}/rel/arm64" >> "$GITHUB_PATH"
      echo "WATCOM=${{github.workspace}}/rel" >> "$GITHUB_ENV"
      echo "INCLUDE=${{github.workspace}}/rel/lh" >> "$GITHUB_ENV"
    shell: bash
  - if: inputs.ow_version == '' && runner.os == 'Windows'
    name: Setup new OW
    run: |
      echo ${{github.workspace}}\rel\binnt>> "%GITHUB_PATH%"
      echo WATCOM=${{github.workspace}}\rel>> "%GITHUB_ENV%"
      echo INCLUDE=${{github.workspace}}\rel\h;${{github.workspace}}\rel\h\nt>> "%GITHUB_ENV%"
    shell: cmd
  - if: runner.os == 'Linux'
    name: Test Bootstrap OW
    run: |
      if [ '${{ env.OWDEBUG }}' = '1' ]; then
        env | sort
      fi
      if [ ! '${{ env.OWTESTMODE }}' = '1' ]; then
        ci/buildx.sh
      fi
    env:
      OWBUILD_STAGE: 'boot'
      OWTOOLS:       'WATCOM'
      OWROOT:        ${{ github.workspace }}
      OWVERBOSE:     1
      OWTESTBOOT:    ${{ inputs.ow_version == '' && '1' || '' }}
    shell: bash
  - if: runner.os == 'Windows'
    name: Test Bootstrap OW
    run: |
      if "${{ env.OWDEBUG }}" == "1" (
        set
      )
      if not "${{ env.OWTESTMODE }}" == "1" (
        ci\buildx.cmd
      )
    env:
      OWBUILD_STAGE: 'boot'
      OWTOOLS:       'WATCOM'
      OWROOT:        ${{ github.workspace }}
      OWVERBOSE:     1
      OWTESTBOOT:    ${{ inputs.ow_version == '' && '1' || '' }}
    shell: cmd
